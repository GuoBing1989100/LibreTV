name: 独立部署到Cloudflare

on:
  push:
    branches:
      - main  # 只在main分支推送时触发
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: read
  deployments: write

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  PROJECT_NAME: "LibreTV"  # 替换为您的实际项目名

jobs:
  build_and_deploy:
    name: 构建并部署
    runs-on: ubuntu-latest

    steps:
      # 步骤1: 检出代码
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 步骤2: 设置Node.js环境
      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 步骤3: 安装依赖
      - name: 安装依赖
        run: |
          npm ci --prefer-offline
          
      # 步骤4: 构建项目
      - name: 构建项目
        run: npm run build  # 替换为您的实际构建命令
        env:
          NODE_ENV: production

      # 步骤5: 部署到Cloudflare Pages
      - name: 部署到Cloudflare
        uses: cloudflare/pages-action@1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.PROJECT_NAME }}
          directory: ./dist  # 替换为您的构建输出目录
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main  # 指定部署分支
          
      # 步骤6: 清理构建产物 (可选)
      - name: 清理工作区
        if: always()
        run: rm -rf node_modules dist .cache
